<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="时光如白马，稍纵即逝。术业有专攻，一生做好一件事真的很重要。">
<meta property="og:type" content="website">
<meta property="og:title" content="zhuxinhong blog">
<meta property="og:url" content="http://zhuxinhong.github.io/index.html">
<meta property="og:site_name" content="zhuxinhong blog">
<meta property="og:description" content="时光如白马，稍纵即逝。术业有专攻，一生做好一件事真的很重要。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="zhuxinhong blog">
<meta name="twitter:description" content="时光如白马，稍纵即逝。术业有专攻，一生做好一件事真的很重要。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhuxinhong.github.io/"/>





  <title>zhuxinhong blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zhuxinhong blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">java coder</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhuxinhong.github.io/2017/07/16/SpringCloud/Hystrix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="祝欣鸿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Wechat.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuxinhong blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/16/SpringCloud/Hystrix/" itemprop="url">Hystrix之hystrix-javanica</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-16T00:00:00+08:00">
                2017-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringCloud/" itemprop="url" rel="index">
                    <span itemprop="name">SpringCloud</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是-Hystrix？"><a href="#什么是-Hystrix？" class="headerlink" title="什么是 Hystrix？"></a>什么是 Hystrix？</h2><p>在分布式环境中，不可避免地会有一些服务依赖项会失败。Hystrix是一个库，它通过添加延迟容忍和容错逻辑来帮助控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点、阻止它们之间的级联故障，并提供备用选项，从而提高系统的整体弹性。</p>
<h2 id="Hystrix-解决什么问题？"><a href="#Hystrix-解决什么问题？" class="headerlink" title="Hystrix 解决什么问题？"></a>Hystrix 解决什么问题？</h2><p>对于每个具有99.99％正常运行时间的30个服务。</p>
<blockquote>
<p>99.99^30 = 99.7％正常运行时间</p>
<p>10亿次请求中的0.3％= 3,000,000次故障</p>
<p>2+小时停机时间/月，即使所有依赖关系都有很好的正常运行时间。</p>
</blockquote>
<p>即使所有依赖关系表现良好，即使0.01％的停机时间对数十个服务中的每一个服务的总体影响等同于每个月停机的潜在时间。</p>
<p>对于高容量流量，单个后端依赖关系故障可能导致所有服务器上资源在几秒钟内饱和。</p>
<h2 id="Hystrix-工作原理"><a href="#Hystrix-工作原理" class="headerlink" title="Hystrix 工作原理"></a>Hystrix 工作原理</h2><ul>
<li>防止任何单个依赖关系使用容器（如Tomcat）全部线程。</li>
<li>减少负载并快速失败，而不是排队。</li>
<li>在可行的情况下提供回退以保护用户免受故障。</li>
<li>使用隔离技术（如隔板，泳道和断路器模式）来限制任何一个依赖的影响。</li>
<li>提供准实时的监控指标、报警。</li>
<li>提供低延迟的配置修改，并支持Hystrix大多数的动态属性更改，以便循环使用低延迟修改进行实时操作修改。</li>
<li>保护整个依赖客户端执行中的故障，而不仅仅是在网络流量中。</li>
</ul>
<h2 id="Hystrix-功能实现"><a href="#Hystrix-功能实现" class="headerlink" title="Hystrix 功能实现"></a>Hystrix 功能实现</h2><ul>
<li><p>通过HystrixCommand或HystrixObservableCommand包装请求，<br>实现在单独的线程中执行（这是命令模式的一种）。</p>
</li>
<li><p>超时调用比您定义的阈值长时间更长。提供一个默认配置，对于大多数依赖调用你可以通过”properties”来自定义它们的超时时间，以使它们的可用性达到99.5%或更高。</p>
</li>
<li><p>为每个依赖调用维护一个小的线程池（或信号量）; 如果它满了，那么依赖调用的请求将立即被拒绝，而不是排队等待。</p>
</li>
<li><p>处理成功，失败（由客户端抛出的异常），超时和线程拒绝。</p>
</li>
<li><p>跳闸断路器可以在一段时间内停止对特定服务的所有请求，如果服务的错误百分比通过阈值，可手动或自动停止。</p>
</li>
<li><p>当请求失败时执行回退逻辑，被拒绝，超时或短路。</p>
</li>
<li><p>准实时监控，运行时变更配置。</p>
</li>
</ul>
<h2 id="hystrix-javanica"><a href="#hystrix-javanica" class="headerlink" title="hystrix-javanica"></a>hystrix-javanica</h2><p>使用完整的hystrix需要大量代码，可能需要花费大量时间写一个Hystrix命令。Javanica旨在通过引入注释来简化使用hystrix。Javanica通过在Spring中声明HystrixCommandAspect这个bean来实现，这里不再赘述AOP。</p>
<p>Javanica 通过 ConfigurationManager 来管理属性配置。</p>
<p>以下注解和代码效果等同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(commandProperties = &#123;</span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>, value = <span class="string">"500"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userResource.getUserById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationManager.getConfigInstance().setProperty(<span class="string">"hystrix.command.getUserById.execution.isolation.thread.timeoutInMilliseconds"</span>, <span class="string">"500"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="HystrixCommand-注解配置"><a href="#HystrixCommand-注解配置" class="headerlink" title="HystrixCommand 注解配置"></a>HystrixCommand 注解配置</h3><h4 id="隔离策略"><a href="#隔离策略" class="headerlink" title="隔离策略"></a>隔离策略</h4><ul>
<li><p>ExecutionIsolationStrategy.THREAD</p>
<p>在一个单独的线程上执行，并发请求受到线程池中线程数量的限制。推荐使用。</p>
</li>
<li><p>ExecutionIsolationStrategy.SEMAPHORE</p>
<p>它在调用线程上执行，并发请求受到信号量计数的限制。开销太大，适用于非网络调用。</p>
</li>
</ul>
<h4 id="HystrixCommand"><a href="#HystrixCommand" class="headerlink" title="HystrixCommand"></a>HystrixCommand</h4><table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">作用</th>
<th style="text-align:center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">groupKey</td>
<td style="text-align:center">所属分组，一个group共用一个线程池</td>
<td style="text-align:center">当前类名</td>
</tr>
<tr>
<td style="text-align:center">commandKey</td>
<td style="text-align:center">业务key</td>
<td style="text-align:center">当前方法名</td>
</tr>
<tr>
<td style="text-align:center">execution.isolation.strategy</td>
<td style="text-align:center">隔离策略</td>
<td style="text-align:center">ExecutionIsolationStrategy.THREAD</td>
</tr>
<tr>
<td style="text-align:center">execution.isolation.thread.timeoutInMilliseconds</td>
<td style="text-align:center">超时时间</td>
<td style="text-align:center">1000ms</td>
</tr>
<tr>
<td style="text-align:center">execution.timeout.enable</td>
<td style="text-align:center">超时开关</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">execution.isolation.thread.interruptOnTimeout</td>
<td style="text-align:center">超时线程中断</td>
<td style="text-align:center">true，Thread模式有效</td>
</tr>
<tr>
<td style="text-align:center">execution.isolation.thread.interruptOnCancel</td>
<td style="text-align:center">取消线程中断</td>
<td style="text-align:center">false，Thread模式有效</td>
</tr>
<tr>
<td style="text-align:center">execution.isolation.semaphore.maxConcurrentRequests</td>
<td style="text-align:center">信号量最大并发度</td>
<td style="text-align:center">10，SEMAPHORE模式有效</td>
</tr>
</tbody>
</table>
<h4 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h4><table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">作用</th>
<th style="text-align:center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">fallback.isolation.semaphore.maxConcurrentRequests</td>
<td style="text-align:center">fallback最大并发度</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">fallback.enabled</td>
<td style="text-align:center">fallback开关</td>
<td style="text-align:center">true</td>
</tr>
</tbody>
</table>
<h4 id="Circuit-Breaker"><a href="#Circuit-Breaker" class="headerlink" title="Circuit Breaker"></a>Circuit Breaker</h4><table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">作用</th>
<th style="text-align:center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">circuitBreaker.enabled</td>
<td style="text-align:center">熔断器开关</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">circuitBreaker.requestVolumeThreshold</td>
<td style="text-align:center">触发熔断的最小个数/10s</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">circuitBreaker.sleepWindowInMilliseconds</td>
<td style="text-align:center">熔断多长时间后去尝试请求</td>
<td style="text-align:center">5000ms</td>
</tr>
<tr>
<td style="text-align:center">circuitBreaker.errorThresholdPercentage</td>
<td style="text-align:center">触发熔断的失败百分比</td>
<td style="text-align:center">50</td>
</tr>
<tr>
<td style="text-align:center">circuitBreaker.forceOpen</td>
<td style="text-align:center">强制打开</td>
<td style="text-align:center">false，设为true会拒绝所有请求</td>
</tr>
<tr>
<td style="text-align:center">circuitBreaker.forceClosed</td>
<td style="text-align:center">强制关闭</td>
<td style="text-align:center">false，设为true会允许所有请求通过</td>
</tr>
</tbody>
</table>
<h4 id="ThreadPool"><a href="#ThreadPool" class="headerlink" title="ThreadPool"></a>ThreadPool</h4><table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">作用</th>
<th style="text-align:center">默认值</th>
<th style="text-align:center">实时修改</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">coreSize</td>
<td style="text-align:center">线程池大小</td>
<td style="text-align:center">10</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:center">maximumSize</td>
<td style="text-align:center">队列大小</td>
<td style="text-align:center">10</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:center">maxQueueSize</td>
<td style="text-align:center">BlockingQueue的最大长度</td>
<td style="text-align:center">-1使用SynchronousQueue，否则使用LinkedBlockingQueue</td>
<td style="text-align:center">初始化时确定，不允许运行时修改</td>
</tr>
<tr>
<td style="text-align:center">queueSizeRejectionThreshold</td>
<td style="text-align:center">队列大小拒绝阈值</td>
<td style="text-align:center">5</td>
<td style="text-align:center">支持，即使maxQueueSize没有达到，也会出现拒绝，因为允许动态更改拒绝队列的大小</td>
</tr>
<tr>
<td style="text-align:center">keepAliveTimeMinutes</td>
<td style="text-align:center">线程释放的空闲时间</td>
<td style="text-align:center">1</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:center">allowMaximumSizeToDivergeFromCoreSize</td>
<td style="text-align:center">maximumSize大于coreSize时，线程空闲时是否释放资源</td>
<td style="text-align:center">false</td>
<td style="text-align:center">支持</td>
</tr>
</tbody>
</table>
<h3 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hystrixAspect"</span> <span class="attr">class</span>=<span class="string">"com.netflix.hystrix.contrib.javanica.aop.aspectj.HystrixCommandAspect"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> HystrixCommandAspect <span class="title">hystrixAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HystrixCommandAspect();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Sync-Execution"><a href="#Sync-Execution" class="headerlink" title="Sync Execution"></a>Sync Execution</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(groupKey=<span class="string">"UserGroup"</span>, commandKey = <span class="string">"GetUserByIdCommand"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userResource.getUserById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Async-Execution"><a href="#Async-Execution" class="headerlink" title="Async Execution"></a>Async Execution</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;User&gt; <span class="title">getUserByIdAsync</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;User&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> userResource.getUserById(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Reactive-Exection"><a href="#Reactive-Exection" class="headerlink" title="Reactive Exection"></a>Reactive Exection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Observable&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;User&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> User&gt; observer)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!observer.isUnsubscribed()) &#123;</span><br><span class="line">                        observer.onNext(<span class="keyword">new</span> User(id, name + id));</span><br><span class="line">                        observer.onCompleted();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    observer.onError(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Fallback-1"><a href="#Fallback-1" class="headerlink" title="Fallback"></a>Fallback</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"defaultUser"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userResource.getUserById(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> User <span class="title">defaultUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"def"</span>, <span class="string">"def"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Hystrix命令和fallback应该在同一个类中，并且具有相同的方法签名(失败执行异常的可选参数)。</li>
<li>如果需要异常，在末尾添加Throwable，对访问修饰符无要求。</li>
<li>fallback方法可以继续添加fallback。</li>
</ul>
<h3 id="Fallback-Exception"><a href="#Fallback-Exception" class="headerlink" title="Fallback Exception"></a>Fallback Exception</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback1"</span>)</span><br><span class="line"><span class="function">User <span class="title">getUserById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"getUserById command failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback2"</span>)</span><br><span class="line"><span class="function">User <span class="title">fallback1</span><span class="params">(String id, Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">"getUserById command failed"</span>.equals(e.getMessage());</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"fallback1 failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback3"</span>)</span><br><span class="line"><span class="function">User <span class="title">fallback2</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"fallback2 failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"staticFallback"</span>)</span><br><span class="line"><span class="function">User <span class="title">fallback3</span><span class="params">(String id, Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">"fallback2 failed"</span>.equals(e.getMessage());</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"fallback3 failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">User <span class="title">staticFallback</span><span class="params">(String id, Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">"fallback3 failed"</span>.equals(e.getMessage());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"def"</span>, <span class="string">"def"</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// test</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	assertEquals(<span class="string">"def"</span>, getUserById(<span class="string">"1"</span>).getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Async-Sync-fallback"><a href="#Async-Sync-fallback" class="headerlink" title="Async/Sync fallback"></a>Async/Sync fallback</h3><ul>
<li>sync command, sync fallback</li>
<li>async command, sync fallback</li>
<li>async command, async fallback</li>
</ul>
<h3 id="Default-fallback"><a href="#Default-fallback" class="headerlink" title="Default fallback"></a>Default fallback</h3><p>该特性允许为整个类或具体的命令定义默认的回退。如果你有一组具有完全相同的回滚逻辑的命令，那么仍然需要为每个命令定义一个fallback，因为fallback应该具有与命令相同的签名，如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/test1"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> APIResponse <span class="title">test1</span><span class="params">(String param1)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some codes here</span></span><br><span class="line">        <span class="keyword">return</span> APIResponse.success(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/test2"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> APIResponse <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some codes here</span></span><br><span class="line">        <span class="keyword">return</span> APIResponse.success(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/test3"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> APIResponse <span class="title">test3</span><span class="params">(ObjectRequest obj)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some codes here</span></span><br><span class="line">        <span class="keyword">return</span> APIResponse.success(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> APIResponse <span class="title">fallback</span><span class="params">(String param1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> APIResponse.failed(<span class="string">"Server is busy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> APIResponse <span class="title">fallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> APIResponse.failed(<span class="string">"Server is busy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> APIResponse <span class="title">fallback</span><span class="params">(ObjectRequest obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> APIResponse.failed(<span class="string">"Server is busy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的fallback特性减少冗余方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DefaultProperties</span>(defaultFallback = <span class="string">"fallback"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/test1"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> APIResponse <span class="title">test1</span><span class="params">(String param1)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some codes here</span></span><br><span class="line">        <span class="keyword">return</span> APIResponse.success(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/test2"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> APIResponse <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some codes here</span></span><br><span class="line">        <span class="keyword">return</span> APIResponse.success(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/test3"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> APIResponse <span class="title">test3</span><span class="params">(ObjectRequest obj)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some codes here</span></span><br><span class="line">        <span class="keyword">return</span> APIResponse.success(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> APIResponse <span class="title">fallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> APIResponse.failed(<span class="string">"Server is busy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的fallback不含任何参数，除了异常参数以获得执行异常，并且不应该抛出任何异常。以下是按下行优先级的顺序排列:</p>
<ol>
<li>@HystrixCommand 定义的 fallbackMethod。</li>
<li>@HystrixCommand 定义的 defaultFallback。</li>
<li>在 class 上 使用 @DefaultProperties 定义的 defaultFallback。</li>
</ol>
<h3 id="错误传播"><a href="#错误传播" class="headerlink" title="错误传播"></a>错误传播</h3><p>@HystrixCommand 提供忽略指定异常不触发fallback的功能。</p>
<pre><code class="Java"><span class="meta">@HystrixCommand</span>(ignoreExceptions = {BadRequestException.class})
<span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(String id)</span> </span>{
    <span class="keyword">return</span> userResource.getUserById(id);
}
</code></pre>
<p>如果 userResource.getUserById(id) 抛出一个 BadRequestException，然后这个异常会裹着 HystrixBadRequestException 再抛出来，不会触发fallback。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhuxinhong.github.io/2017/06/12/编写高质量代码/工程质量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="祝欣鸿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Wechat.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuxinhong blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/12/编写高质量代码/工程质量/" itemprop="url">工程质量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-12T00:00:00+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编写高质量代码/" itemprop="url" rel="index">
                    <span itemprop="name">编写高质量代码</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="开源工具的选择"><a href="#开源工具的选择" class="headerlink" title="开源工具的选择"></a>开源工具的选择</h1><ul>
<li><p>普适性原则</p>
<p>确保大部分项目成员对工具都比较熟悉。</p>
</li>
<li><p>唯一性原则</p>
<p>相同的工具只选择一个或一种，不让多种相同或相似职能的工具共存。例如集合工具 Apache Commons 的 collections 包和 Google Guava 的 collections 工具包，在开发前就应该确认下来，不能让两者共存。</p>
</li>
<li><p>“大树纳凉”</p>
<p>选择比较有名的开源组织，比如 Apache、Spring、Google 等。这些开源组织一则具有固定的开发运作风格，二则具有广阔的使用人群。</p>
</li>
<li><p>精而专</p>
<p>我们选择的工具包应该是精而专的，而不是广而多。比如 Spring 框架提供了 Utils 工具包，但在一般情况下不要使用它，因为它不专，Utils 包只是 Spring 中的一个附加功能而已，要用就用 Apache Commons 的 BeanUtils、Long 等工具包。</p>
</li>
<li><p>高热度</p>
<p>热度越高，更新越频繁，使用人群越光，BUG 曝光率越快，修复效率越高，对醒目的稳定性越好。</p>
</li>
</ul>
<h1 id="良好的代码风格"><a href="#良好的代码风格" class="headerlink" title="良好的代码风格"></a>良好的代码风格</h1><ul>
<li><p>整洁、统一、流行</p>
<p>推荐 Google 的 Java 编码规范，《代码整洁之道》。</p>
<ol>
<li>好的变量命名，类的命名，方法命名。比如 Spring 源码里面命名老长老长的，但很好懂。</li>
<li>方法入参超过 3 个就该考虑封装成对象。</li>
</ol>
</li>
</ul>
<ul>
<li><p>便捷</p>
<p>推荐 IDE code format。</p>
</li>
</ul>
<h1 id="错误的编码习惯"><a href="#错误的编码习惯" class="headerlink" title="错误的编码习惯"></a>错误的编码习惯</h1><ol>
<li><p>自由格式的代码</p>
<p>不同项目，甚至同一个项目不同开发人员的风格也不同。</p>
</li>
<li><p>不使用抽象的代码</p>
<p>抽象的意义不在于编码，而是在于对业务的理解，接口是对业务宏观的描述，而不是实现代码。</p>
</li>
<li><p>彰显个性的代码</p>
<p>新技术只能作为技术的一个方向，不适合立刻投入生产中。项目的运行质量远远高于代码质量。“最小惊诧原则”，意思是说使用最常见的，而不是最新颖的功能。编码时，应寻找最常用的方法来实现。</p>
</li>
<li><p>死代码</p>
<p>可能是忘记删除的代码，也可能是故意保留的类似“到此一游”的签名代码，这些代码按照正常的执行逻辑不可能被执行到。</p>
</li>
<li><p>冗余代码</p>
<p>写了一个实现类，N 天后被废弃了，之后这个类就永久的保留下去了，没人知道它为什么没被删除掉。</p>
</li>
<li><p>自以为是的代码</p>
<p>相信自己编写的工具类，而不是开源工具。宁愿自己写序列化工具，也不选择 kryo 或 protostuff；宁愿自己写日期处理工具，也不选择 Joda 或 date4j。</p>
</li>
</ol>
<h1 id="技术自律"><a href="#技术自律" class="headerlink" title="技术自律"></a>技术自律</h1><ol>
<li><p>熟悉工具</p>
<p>常见工具类，例如 Apache Common， Google Guava。</p>
</li>
<li><p>坚持重构</p>
<p>不要相信一次就能写出优秀的代码，这不现实，任何优秀的代码、算法都是经过多次重构磨炼的。</p>
</li>
<li><p>多写文档</p>
<p>不仅仅是为了后续的参与人员，同时也为了整理自己的思维。</p>
</li>
<li><p>保持程序简单</p>
<p>一个项目不要保持多个版本，即使有分支也必须定义出项目合并的条件，或时间约束或目标约束，不可任由版本扩散。</p>
</li>
<li><p>不重复造轮子</p>
<p>在项目中使用已经成熟的工具或框架，而不是自己编写。但如果想共享一个新的框架，尽管去重复发明轮子，它不是以交付为目的，耳塞以技术研究为目的。</p>
</li>
<li><p>“剽窃”不可耻</p>
<p>多看开源代码，学习一下人家的编码方式。</p>
</li>
<li><p>分享</p>
<p>把自己的代码分享出去收获的不仅仅是赞许，还有自己能力的提升。</p>
</li>
<li><p>刨根问底</p>
<p>”哦，这个问题加上这个参数就可以解决了”—-这不是解决问题的办法，在答案之后加上“是因为。。。”，这才是解决了问题。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhuxinhong.github.io/2017/06/11/编写高质量代码/数组和集合/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="祝欣鸿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Wechat.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuxinhong blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/11/编写高质量代码/数组和集合/" itemprop="url">数组和集合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-11T00:00:00+08:00">
                2017-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编写高质量代码/" itemprop="url" rel="index">
                    <span itemprop="name">编写高质量代码</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="#不同的列表选择不同的遍历方法">不同的列表选择不同的遍历方法</a></li>
<li><a href="#子列表只是原列表的一个视图">子列表只是原列表的一个视图</a></li>
<li><a href="#优雅的集合运算">优雅的集合运算</a></li>
</ul>
<h2 id="不同的列表选择不同的遍历方法"><a href="#不同的列表选择不同的遍历方法" class="headerlink" title="不同的列表选择不同的遍历方法"></a>不同的列表选择不同的遍历方法</h2><p>案例：统计一个省的各科高考平均值，比如数学平均分，使用纯 Java 算法来解决，看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> stuNum = <span class="number">80</span> * <span class="number">10000</span>;</span><br><span class="line">    List&lt;Integer&gt; scores = <span class="keyword">new</span> ArrayList&lt;Integer&gt;(stuNum);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; stuNum; i++) &#123;</span><br><span class="line">        scores.add(<span class="keyword">new</span> Random().nextInt(<span class="number">150</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    foreach(scores);</span><br><span class="line">    get(scores);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">foreach</span><span class="params">(List&lt;Integer&gt; list)</span> </span>&#123;</span><br><span class="line">    Long start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    Integer sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Integer i : list) &#123;</span><br><span class="line">        sum += i;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"avg score: "</span> + sum / list.size());</span><br><span class="line"></span><br><span class="line">    Long end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(end - start);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">(List&lt;Integer&gt; list)</span> </span>&#123;</span><br><span class="line">    Long start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    Integer sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">        sum += list.get(i);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"avg score: "</span> + sum / list.size());</span><br><span class="line"></span><br><span class="line">    Long end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(end - start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">avg score: 74</span><br><span class="line">42</span><br><span class="line">avg score: 74</span><br><span class="line">19</span><br></pre></td></tr></table></figure>
<p>发现不使用 foreach 方式遍历列表，采用下标方式遍历，效率翻倍提高，这是为什么？</p>
<p>这是因为 ArrayList 数组实现了 RandomAccess 接口（随机存取接口），这也就标志着 ArrayList 是一个可以随机存取的列表。在 Java 中，RandomAccess 和 Cloneable、Serializable 一样，都是标志性接口，一般不需要实现，只是用来表明其实现类具有某种特质，实现了 RandomAccess 表明这个类可以随机存取，对我们的 ArrayList 来说也就标志着其数据元素之间没有关联，即两个位置相邻的元素之间没有相互依赖和索引关系，可以随机访问和存储。</p>
<p> 我们知道，Java 中的 foreach 语法是 iterator 的变形用法，也就是说上面的 foreach 与下面的代码等价：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Iterator&lt;Integer&gt; i = list.iterator(); i.hasNext();)&#123;</span><br><span class="line">  sum += i.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们再想想什么是迭代器，迭代器是 23 个设计模式中的一种，“提供一种方法访问同一个容器对象中的各个元素、同时又无须暴露该对象的内部细节”，也就是说对于 ArrayList，需要先创建一个迭代器容器、然后屏蔽内部遍历细节，对外提供 hasNext、next 等方法。问题是 ArrayList 实现了 RandomAccess 接口，已表明元素之间本来没有关系，可是为了使用迭代器就需要强制建立一种互相”知晓“的关系，比如上一个元素可以判断是否有下一个元素，以及与下一个元素是什么关系等，这也就是通过 foreach 遍历耗时的原因。</p>
<p>Java 为 ArrayList 加上了 RandomAccess 接口，就是在告诉我们要使用下标方式遍历会更快，接着又有一个问题：为什么不把 RandomAccess 加到所有 List 实现上呢？</p>
<p>因为有些 List 实现类不是随机存取的，而是有序存取的，比如 LinkedList，它实现了双向链表。LinkedList 中的两个元素本来就是有关联的，我知道你的存在，你也知道我的存在。既然元素之间已经有关联关系了，使用 foreach 也就是迭代器方式必然效率更高。</p>
<p>可能大家还想测试一下下标方式遍历 LinkedList 元素的情况，其实不用测试也能想到效率非常低下，我们看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Node&lt;E&gt; <span class="title">node</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert isElementIndex(index);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序会先判断输入的下标与中间值（size 右移一位，也就是除以2了）的关系，小于中间值则从头开始正向搜索，大于中间值则从尾节点反向搜索，想想看，每次的 get 方法都是一个遍历，”性能“从何说起。</p>
<p>明白了随机存起列表和有序存取列表的区别，我们的 average 方法就必须重构了，以便实现不同的列表采用不同的遍历方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (list <span class="keyword">instanceof</span> RandomAccess) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">              sum += list.get(i);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">for</span> (Integer i : list) &#123;</span><br><span class="line">              sum += i;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(<span class="string">"avg score: "</span> + sum / list.size());</span><br></pre></td></tr></table></figure>
<h2 id="子列表只是原列表的一个视图"><a href="#子列表只是原列表的一个视图" class="headerlink" title="子列表只是原列表的一个视图"></a>子列表只是原列表的一个视图</h2><p>List 接口提供了 subList 方法，返回一个列表的子列表，看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; c = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    c.add(<span class="string">"A"</span>);</span><br><span class="line">    c.add(<span class="string">"B"</span>);</span><br><span class="line">    List&lt;String&gt; c1 = <span class="keyword">new</span> ArrayList&lt;&gt;(c);</span><br><span class="line">    List&lt;String&gt; c2 = c.subList(<span class="number">0</span>, c.size());</span><br><span class="line">    c2.add(<span class="string">"C"</span>);</span><br><span class="line">    System.out.println(<span class="string">"c == c1 ? "</span> + c.equals(c1));</span><br><span class="line">    System.out.println(<span class="string">"c == c2 ? "</span> + c.equals(c2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c == c1 ? false</span><br><span class="line">c == c2 ? true</span><br></pre></td></tr></table></figure>
<p>这和 String 类的 subString 刚好相反，我们从源代码来分析，subList 源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;E&gt; <span class="title">subList</span><span class="params">(<span class="keyword">int</span> fromIndex, <span class="keyword">int</span> toIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span> <span class="keyword">instanceof</span> RandomAccess ?</span><br><span class="line">            <span class="keyword">new</span> RandomAccessSubList&lt;&gt;(<span class="keyword">this</span>, fromIndex, toIndex) :</span><br><span class="line">            <span class="keyword">new</span> SubList&lt;&gt;(<span class="keyword">this</span>, fromIndex, toIndex));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>subList 方法是由 AbstractList 实现的，它会根据是不是 RandomAccess 来提供不同的 SubList 实现。再看看 SubList 代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">SubList(AbstractList&lt;E&gt; list, <span class="keyword">int</span> fromIndex, <span class="keyword">int</span> toIndex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fromIndex &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"fromIndex = "</span> + fromIndex);</span><br><span class="line">    <span class="keyword">if</span> (toIndex &gt; list.size())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"toIndex = "</span> + toIndex);</span><br><span class="line">    <span class="keyword">if</span> (fromIndex &gt; toIndex)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"fromIndex("</span> + fromIndex +</span><br><span class="line">                                           <span class="string">") &gt; toIndex("</span> + toIndex + <span class="string">")"</span>);</span><br><span class="line">    l = list;</span><br><span class="line">    offset = fromIndex;</span><br><span class="line">    size = toIndex - fromIndex;</span><br><span class="line">    <span class="keyword">this</span>.modCount = l.modCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    checkForComodification();</span><br><span class="line">    <span class="keyword">return</span> l.set(index+offset, element);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    checkForComodification();</span><br><span class="line">    <span class="keyword">return</span> l.get(index+offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    rangeCheckForAdd(index);</span><br><span class="line">    checkForComodification();</span><br><span class="line">    l.add(index+offset, element);</span><br><span class="line">    <span class="keyword">this</span>.modCount = l.modCount;</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    checkForComodification();</span><br><span class="line">    E result = l.remove(index+offset);</span><br><span class="line">    <span class="keyword">this</span>.modCount = l.modCount;</span><br><span class="line">    size--;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这段代码，了解了 subList 方法实现原理：它返回的 SubList 类也是 AbstractList 子类，其所有方法如 get、set、add、remove 等都是在原始列表上的操作，它自身并没有生成一个数组或是链表，也就是子列表只是原列表的一个视图，所有的修改动作都反映在了原列表上。</p>
<h2 id="优雅的集合运算"><a href="#优雅的集合运算" class="headerlink" title="优雅的集合运算"></a>优雅的集合运算</h2><h3 id="并集"><a href="#并集" class="headerlink" title="并集"></a>并集</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list1.addAll(list2);</span><br></pre></td></tr></table></figure>
<h3 id="交集"><a href="#交集" class="headerlink" title="交集"></a>交集</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list1.retainAll(list2);</span><br></pre></td></tr></table></figure>
<p>该方法会删除 list1 中没有出现在 list2 中的元素。</p>
<h3 id="差集"><a href="#差集" class="headerlink" title="差集"></a>差集</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list1.removeAll(list2);</span><br></pre></td></tr></table></figure>
<h3 id="无重复的并集"><a href="#无重复的并集" class="headerlink" title="无重复的并集"></a>无重复的并集</h3><p>什么叫无重复的并集？并集是集合 A 加集合 B，如果集合 A 和集合 B 有交集（也就是并集的元素数量大于0），就需要确保并集的结果中只有一份交集，此为无重复的并集。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list2.removeAll(list1);</span><br><span class="line">list1.addAll(list2);</span><br></pre></td></tr></table></figure>
<p>有人可能有疑问，求出两个集合的并集，转变为 HashSet 剔除重复元素不就解决问题了吗？其实是不行的，比如集合 A 有 10 个元素（其中有两个元素值相同），集合 B 有 8 个元素，它们的交集有 2 个元素，我们可以计算出它们的并集是 18 个元素，而无重复的并集有 16 个元素，但是如果使用 HashSet，算出来则只有 15 个元素，因为把集合 A 中原本重复的元素也剔除掉了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhuxinhong.github.io/2017/06/03/编写高质量代码/字符串/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="祝欣鸿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Wechat.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuxinhong blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/编写高质量代码/字符串/" itemprop="url">字符串</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T00:00:00+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编写高质量代码/" itemprop="url" rel="index">
                    <span itemprop="name">编写高质量代码</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="#字符串拼接方法">字符串拼接方法</a></li>
</ul>
<h3 id="字符串拼接方法"><a href="#字符串拼接方法" class="headerlink" title="字符串拼接方法"></a>字符串拼接方法</h3><p>对一个字符串进行拼接有三种方法：加号、concat 及 StringBuilder （或 StringBuffer）的 append 方法，这三者之间有什么区别吗？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str += “c”;</span><br><span class="line">str = str.concat(<span class="string">"c"</span>);</span><br></pre></td></tr></table></figure>
<p>上面两种不同字符串拼接方式、循环5万次后检查执行时间，加号方式执行时间为 2000ms，而 concat 方法执行时间为 685ms，时间相差一倍，如果使用 StringBuilder，执行时间 7ms。从这个试验中可以看出 append 方法最快，concat 其次，加号最慢。</p>
<h5 id="加号方法"><a href="#加号方法" class="headerlink" title="加号方法"></a>加号方法</h5><p>编译器对字符串的加号做了优化，它会使用 StringBuilder 的 append 方法追加，讲道理它的执行时间也应该在 10ms 以内，不过它最终是通过 toString 方法转换成 String 字符串的，例子中的代码与如下代码相同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str = <span class="keyword">new</span> StringBuilder(str).append(<span class="string">"c"</span>).toString();</span><br></pre></td></tr></table></figure>
<p>这与纯粹使用 StringBuilder 的 append 方法是不同的：</p>
<ol>
<li>每次循环都会创建一个 StringBuilder 对象</li>
<li>每次执行完毕都要调用 toString 方法将其转换为字符串</li>
</ol>
<h5 id="concat-方法"><a href="#concat-方法" class="headerlink" title="concat 方法"></a>concat 方法</h5><p>我们看一下 concat 源码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">concat</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> otherLen = str.length();</span><br><span class="line">        <span class="keyword">if</span> (otherLen == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> len = value.length;</span><br><span class="line">        <span class="keyword">char</span> buf[] = Arrays.copyOf(value, len + otherLen);</span><br><span class="line">        str.getChars(buf, len);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(buf, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整体看上去是一个数组拷贝，虽然在内存中处理都是原子性操作，速度非常快。不过最后的 return 语句，每次 concat 操作都会新创建一个 String 对象，这就是 concat 速度慢下来的真正原因。</p>
<h5 id="append-方法"><a href="#append-方法" class="headerlink" title="append 方法"></a>append 方法</h5><p>StringBuilder 的 append 方法直接由父类 AbstractStringBuilder 实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbstractStringBuilder <span class="title">append</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> appendNull();</span><br><span class="line">    <span class="keyword">int</span> len = str.length();</span><br><span class="line">    ensureCapacityInternal(count + len);</span><br><span class="line">    str.getChars(<span class="number">0</span>, len, value, count);</span><br><span class="line">    count += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个 append 方法都在做字符数组处理，加上后数组拷贝，这些都是基本的数据处理，没有新建任何对象，所以速度也就最快了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhuxinhong.github.io/2017/03/23/Java Web/可能错过的Java7特性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="祝欣鸿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Wechat.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuxinhong blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/23/Java Web/可能错过的Java7特性/" itemprop="url">Java7 -- 可能错过的Java7特性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-23T00:00:00+08:00">
                2017-03-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-Web/" itemprop="url" rel="index">
                    <span itemprop="name">Java Web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="可能错过的Java7特性"><a href="#可能错过的Java7特性" class="headerlink" title="可能错过的Java7特性"></a>可能错过的Java7特性</h1><ul>
<li>异常改进</li>
<li>文件IO</li>
<li>equals、hashCode和CompareTo方法</li>
<li>其他</li>
</ul>
<h2 id="异常改进"><a href="#异常改进" class="headerlink" title="异常改进"></a>异常改进</h2><h3 id="try-with-resources"><a href="#try-with-resources" class="headerlink" title="try-with-resources"></a>try-with-resources</h3><p>Java7 提供了一个简单实用的代码格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">打开一个资源</span><br><span class="line"><span class="keyword">try</span>	&#123;</span><br><span class="line">	实用该资源</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">	关闭该资源</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中资源所属类必须实现了 AutoCloseable 接口。</p>
<p>void close() throws Exception</p>
<p>try-with-resources 语句最简形式如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (Resource res = ...) &#123;</span><br><span class="line">	使用 res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当 try 语句块退出时，会自动调用 res.close() 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (Scanner in = <span class="keyword">new</span> Scanner(Paths.get(File.separator, <span class="string">"data"</span>, <span class="string">"word"</span>))) &#123;</span><br><span class="line">    <span class="keyword">while</span> (in.hasNext()) &#123;                                                 </span><br><span class="line">        System.out.println(in.next());                                     </span><br><span class="line">    &#125;                                                                      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当代码块像往常一样退出或发生异常时，都会调用 in.close() 方法，就如同你之前使用 finally 一样。</p>
<h3 id="忽略异常"><a href="#忽略异常" class="headerlink" title="忽略异常"></a>忽略异常</h3><p>无论何时使用输入或输出，在异常产生后如何关闭资源都是一个麻烦的问题。假设产生了一个 IOException ，接下来关闭资源事， close 方法又抛出了另一个异常。</p>
<p>实际在Java中，finally分支中抛出的异常会丢弃掉之前的异常。</p>
<p>try-with-resources 修正了这个行为。当 AutoCloseable 的 close 方法抛出异常时，原来的异常会被重新抛出，而调用 close 方法产生的异常会被捕获，并被标注为“被忽略”的异常。</p>
<h3 id="捕获多个异常"><a href="#捕获多个异常" class="headerlink" title="捕获多个异常"></a>捕获多个异常</h3><p>假设多个异常的行为一致，允许将多个异常写在一个 catch 分支中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException | UnknownHostException ex) &#123;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ex)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有当捕获的异常均不是其他异常的子类时，才能用这种方法。</p>
<h3 id="ReflectiveOperationException"><a href="#ReflectiveOperationException" class="headerlink" title="ReflectiveOperationException"></a>ReflectiveOperationException</h3><p>在调用一个反射方法时，不得不捕获许多不相关的检查器异常。例如，创建一个类并调用它的 main 方法：</p>
<p>Class.forName(className).getMethod(“main”).invoke(null, new String[]{});</p>
<p>该语句可能会导致一个 ClassNotFoundException、NoSuchMethodException、IllegalAccessException 或者 InvocationTargetException。</p>
<p>Java7 修复了这一设计上的缺陷，引入了一个新的父类 ReflectiveOperationException, 这样就可以通过这一个异常来捕获其他所有子异常。</p>
<h2 id="使用文件"><a href="#使用文件" class="headerlink" title="使用文件"></a>使用文件</h2><p>文件处理上，Java7 的 Path 接口取代了 File 类。</p>
<h3 id="Path-Paths"><a href="#Path-Paths" class="headerlink" title="Path Paths"></a>Path Paths</h3><h3 id="Files"><a href="#Files" class="headerlink" title="Files"></a>Files</h3><p>Files 类可以快速实现一些常用的文件 IO 操作，比之前的读写文件编码简洁太多。例如：</p>
<h4 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h4><p>读取一个文件全部内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] bytes = Files.readAllBytes(path);</span><br></pre></td></tr></table></figure>
<p>将文件内容读取为一个字符串</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String content = <span class="keyword">new</span> String(bytes, StandardCharsets.UTF_8);</span><br></pre></td></tr></table></figure>
<p>按行读取文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; lines = Files.readAllLines(path);</span><br></pre></td></tr></table></figure>
<p>将字符串写入文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.write(path, <span class="string">"content"</span>.getBytes(StandardCharsets.UTF_8));</span><br></pre></td></tr></table></figure>
<p>按行来写入文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; lines = Arrays.asList(<span class="string">"abc"</span>, <span class="string">"xyz"</span>);</span><br><span class="line">Files.write(path, lines);</span><br></pre></td></tr></table></figure>
<p>将内容追加到文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; lines = Arrays.asList(<span class="string">"abc"</span>, <span class="string">"xyz"</span>);</span><br><span class="line">Files.write(path, lines, StandardOpenOption.APPEND);</span><br></pre></td></tr></table></figure>
<p>默认情况下，Files 类的所有方法都使用 UTF-8 来读取或写入字符。</p>
<p>处理一般大小文本文件时，通常最简单方法是将文件内容作为一个字符串或者字符串列表进行处理。如果文件很大，或者是二进制文件，仍然可以使用熟悉的 stream 类或者 reader/writer 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">InputStream in = Files.newInputStream(path);</span><br><span class="line">OutputStream out = Files.newOutPutStream(path);</span><br><span class="line">Reader reader = Files.newBufferedReader(path);</span><br><span class="line">Writer writer = Files.newBufferedWriter(path);</span><br></pre></td></tr></table></figure>
<p>这些方便的方法可以帮你省去处理 FileInputStream、FileOutputStream、BufferedReader 或者 BufferedWriter 时的工作。</p>
<p>如果希望将一个 InputStream 中的内容保存到一个文件中，可以使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.copy(in, path);</span><br></pre></td></tr></table></figure>
<p>相反，可以将某个文件内容复制到一个 OutputStream 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.copy(path, out);</span><br></pre></td></tr></table></figure>
<h4 id="创建文件和目录"><a href="#创建文件和目录" class="headerlink" title="创建文件和目录"></a>创建文件和目录</h4><p>创建目录                </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.createDirectories(path);</span><br></pre></td></tr></table></figure>
<p>创建空文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.createFile(path);</span><br></pre></td></tr></table></figure>
<p>文件已经存在会抛异常，对已有文件的检查和创建都属于原子操作，所以如果文件不存在，那么它一定会在其他线程之前创建该文件。</p>
<h4 id="复制、移动和删除文件"><a href="#复制、移动和删除文件" class="headerlink" title="复制、移动和删除文件"></a>复制、移动和删除文件</h4><p>复制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.copy(fromPath, toPath);</span><br></pre></td></tr></table></figure>
<p>移动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.move(fromPath, toPath);</span><br></pre></td></tr></table></figure>
<p>如果目标文件或目录存在，copy 或 move 方法会失败。如果希望覆盖目标文件，使用 REPLACE_EXISTING 选项。如果希望复制所有文件属性，使用 COPY_ATTRIBUTES 选项，也可同时提供这两个选项：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.copy(fromPath, toPath, StandardCopyOption.REPLACE_EXISTING, StandardCopyOption.COPY_ATTRIBUTES);</span><br></pre></td></tr></table></figure>
<p>可指定使用原子方式来执行移动，这样要么移动操作成功完成，要么源文件依然存在：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.move(fromPath, toPath, StandardCopyOption.ATOMIC_MOVE);</span><br></pre></td></tr></table></figure>
<p>删除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.delete(path);</span><br></pre></td></tr></table></figure>
<p>如果文件不存在会抛异常，可能希望使用另一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> deleted = Files.deleteIfExists(path);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">没有直接删除或复制非空目录的方法。要实现请参考 FileVisitor 接口的API文档。</span><br></pre></td></tr></table></figure>
<h2 id="equals、hashcode、和-compareTo-方法"><a href="#equals、hashcode、和-compareTo-方法" class="headerlink" title="equals、hashcode、和 compareTo 方法"></a>equals、hashcode、和 compareTo 方法</h2><h3 id="安全的-Null-值相等测试"><a href="#安全的-Null-值相等测试" class="headerlink" title="安全的 Null 值相等测试"></a>安全的 Null 值相等测试</h3><p>假设需要为下面的类实现 equals 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String first;</span><br><span class="line">	<span class="keyword">private</span> String last;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，你不得不将参数转换为一个 Person 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object otherObject)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span> == otherObject) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">if</span> (otherObject == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.getClass() != otherObject.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	Person other = (Person) otherObject;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java7出现后，再不用担心 first 或者 last 可能为空，只需调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Obejcts.equals(a, b);</span><br></pre></td></tr></table></figure>
<p>如果 a 和 b 都是 null，则返回 true；如果只有 a 为 null，则返回 false；其他情况则返回 a.equals(b)。</p>
<h3 id="计算哈希码"><a href="#计算哈希码" class="headerlink" title="计算哈希码"></a>计算哈希码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Objects.hash(first, last);</span><br></pre></td></tr></table></figure>
<p>Objects.hash 只是会调用从 Java5 开始就存在的 Arrays.hash 方法。但他不是一个支持可变参数的方法。</p>
<h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString()"></a>toString()</h3><p>String.valueOf(obj)，可以安全处理 null 对象。如果 obj 为 null，会返回字符串 “null”。如果不喜欢这种方式，可以调用 Objects.toString 方法，并提供一个用于 null 对象的值。例如，Objects.toString(obj, “”);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the result of calling &#123;<span class="doctag">@code</span> toString&#125; on the first</span></span><br><span class="line"><span class="comment"> * argument if the first argument is not &#123;<span class="doctag">@code</span> null&#125; and returns</span></span><br><span class="line"><span class="comment"> * the second argument otherwise.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> o an object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nullDefault string to return if the first argument is</span></span><br><span class="line"><span class="comment"> *        &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the result of calling &#123;<span class="doctag">@code</span> toString&#125; on the first</span></span><br><span class="line"><span class="comment"> * argument if it is not &#123;<span class="doctag">@code</span> null&#125; and the second argument</span></span><br><span class="line"><span class="comment"> * otherwise.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Objects#toString(Object)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toString</span><span class="params">(Object o, String nullDefault)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (o != <span class="keyword">null</span>) ? o.toString() : nullDefault;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="比较数值类型对象"><a href="#比较数值类型对象" class="headerlink" title="比较数值类型对象"></a>比较数值类型对象</h3><p>使用静态方法 Integer.compare </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> diff = Integer.compare(x, other.x);</span><br><span class="line"><span class="keyword">if</span> (diff != <span class="number">0</span>) <span class="keyword">return</span> diff;</span><br><span class="line"><span class="keyword">return</span> Integer.compare(y, other.y);</span><br></pre></td></tr></table></figure>
<p>过去某些开发人员会使用 new Integer(x).compareTo(other.x)的方式，但这会创建两个会自动装箱/拆箱的整形对象。相比之下，静态方法 compare 使用的是 int 参数。</p>
<p>此外，Long、Short、Byte、和 Boolean 也都提供了各自的静态方法 compare。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Double 和 Float 中的静态方法 compare 从 Java1.2 开始就存在了。</span><br></pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="字符串转数字"><a href="#字符串转数字" class="headerlink" title="字符串转数字"></a>字符串转数字</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> x = Double.parseDouble(<span class="string">"+1.0"</span>);</span><br><span class="line"><span class="keyword">int</span> n = Integer.parseInt(<span class="string">"+1"</span>);</span><br></pre></td></tr></table></figure>
<p>在 Java7 之前，+1 一直不是一个有效整数。</p>
<p>现在这个问题已经在所有通过字符串来构造 int、long、short、byte 和 BigInteger 的方法中被修复了，还包括包装类、处理十六进制和八进制数输入的 decode 方法，一级生成包装类对象的 valueOf 方法。BigInteger(String) 也被修复了。</p>
<h3 id="全局-Logger"><a href="#全局-Logger" class="headerlink" title="全局 Logger"></a>全局 Logger</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger <span class="title">getGlobal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// In order to break a cyclic dependence between the LogManager</span></span><br><span class="line">    <span class="comment">// and Logger static initializers causing deadlocks, the global</span></span><br><span class="line">    <span class="comment">// logger is created with a special constructor that does not</span></span><br><span class="line">    <span class="comment">// initialize its log manager.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If an application calls Logger.getGlobal() before any logger</span></span><br><span class="line">    <span class="comment">// has been initialized, it is therefore possible that the</span></span><br><span class="line">    <span class="comment">// LogManager class has not been initialized yet, and therefore</span></span><br><span class="line">    <span class="comment">// Logger.global.manager will be null.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// In order to finish the initialization of the global logger, we</span></span><br><span class="line">    <span class="comment">// will therefore call LogManager.getLogManager() here.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// To prevent race conditions we also need to call</span></span><br><span class="line">    <span class="comment">// LogManager.getLogManager() unconditionally here.</span></span><br><span class="line">    <span class="comment">// Indeed we cannot rely on the observed value of global.manager,</span></span><br><span class="line">    <span class="comment">// because global.manager will become not null somewhere during</span></span><br><span class="line">    <span class="comment">// the initialization of LogManager.</span></span><br><span class="line">    <span class="comment">// If two threads are calling getGlobal() concurrently, one thread</span></span><br><span class="line">    <span class="comment">// will see global.manager null and call LogManager.getLogManager(),</span></span><br><span class="line">    <span class="comment">// but the other thread could come in at a time when global.manager</span></span><br><span class="line">    <span class="comment">// is already set although ensureLogManagerInitialized is not finished</span></span><br><span class="line">    <span class="comment">// yet...</span></span><br><span class="line">    <span class="comment">// Calling LogManager.getLogManager() unconditionally will fix that.</span></span><br><span class="line"></span><br><span class="line">    LogManager.getLogManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now the global LogManager should be initialized,</span></span><br><span class="line">    <span class="comment">// and the global logger should have been added to</span></span><br><span class="line">    <span class="comment">// it, unless we were called within the constructor of a LogManager</span></span><br><span class="line">    <span class="comment">// subclass installed as LogManager, in which case global.manager</span></span><br><span class="line">    <span class="comment">// would still be null, and global will be lazily initialized later on.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> global;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Null-检查"><a href="#Null-检查" class="headerlink" title="Null 检查"></a>Null 检查</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks that the specified object reference is not &#123;<span class="doctag">@code</span> null&#125;. This</span></span><br><span class="line"><span class="comment"> * method is designed primarily for doing parameter validation in methods</span></span><br><span class="line"><span class="comment"> * and constructors, as demonstrated below:</span></span><br><span class="line"><span class="comment"> * &lt;blockquote&gt;&lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * public Foo(Bar bar) &#123;</span></span><br><span class="line"><span class="comment"> *     this.bar = Objects.requireNonNull(bar);</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;&lt;/blockquote&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj the object reference to check for nullity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; the type of the reference</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> obj&#125; if not &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> obj&#125; is &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">requireNonNull</span><span class="params">(T obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks that the specified object reference is not &#123;<span class="doctag">@code</span> null&#125; and</span></span><br><span class="line"><span class="comment"> * throws a customized &#123;<span class="doctag">@link</span> NullPointerException&#125; if it is. This method</span></span><br><span class="line"><span class="comment"> * is designed primarily for doing parameter validation in methods and</span></span><br><span class="line"><span class="comment"> * constructors with multiple parameters, as demonstrated below:</span></span><br><span class="line"><span class="comment"> * &lt;blockquote&gt;&lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * public Foo(Bar bar, Baz baz) &#123;</span></span><br><span class="line"><span class="comment"> *     this.bar = Objects.requireNonNull(bar, "bar must not be null");</span></span><br><span class="line"><span class="comment"> *     this.baz = Objects.requireNonNull(baz, "baz must not be null");</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;&lt;/blockquote&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj     the object reference to check for nullity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message detail message to be used in the event that a &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> *                NullPointerException&#125; is thrown</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; the type of the reference</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> obj&#125; if not &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> obj&#125; is &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">requireNonNull</span><span class="params">(T obj, String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(message);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h3><p>Java5 之前，Runtime.exec 方法是在 Java 中执行一个外部命令的唯一方式。Java5 添加了 ProcessBuilder 类，加强了对 OS 进程的控制，尤其是通过 ProcessBuilder，你可以改变工作目录。</p>
<p>Java7 添加了一些新方法，使得开发人员能方便地将进程的标准输入、输出及错误重定向到文件中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> Redirect <span class="title">redirectInput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (redirects == <span class="keyword">null</span>) ? Redirect.PIPE : redirects[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Redirect <span class="title">redirectOutput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (redirects == <span class="keyword">null</span>) ? Redirect.PIPE : redirects[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> ProcessBuilder <span class="title">redirectInput</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> redirectInput(Redirect.from(file));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> ProcessBuilder <span class="title">redirectOutput</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> redirectOutput(Redirect.to(file));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Redirect <span class="title">redirectError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (redirects == <span class="keyword">null</span>) ? Redirect.PIPE : redirects[<span class="number">2</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> ProcessBuilder <span class="title">redirectError</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> redirectError(Redirect.to(file));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h3><p>Java7 只是添加了一个用来关闭该类加载器的 close 方法，URLClassLoader 类现在实现了 AutoCloseable 接口，因此可使用 try-with-resources 语句来避免可能出现的资源泄露。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLClassLoader</span> <span class="keyword">extends</span> <span class="title">SecureClassLoader</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BitSet"><a href="#BitSet" class="headerlink" title="BitSet"></a>BitSet</h3><p>BitSet 是一个表示 bit 序列的整数集合。该集合可以根据整数 i 来设置第 i 个 bit 位的值。这使得集合操作非常搞笑。求并集、交集、补集只不过是简单的按位或、与、非运算。</p>
<p>Java7 添加了一些构造 BitSet 的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitSet <span class="title">valueOf</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BitSet.valueOf(ByteBuffer.wrap(bytes));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitSet <span class="title">valueOf</span><span class="params">(ByteBuffer bb)</span> </span>&#123;</span><br><span class="line">    bb = bb.slice().order(ByteOrder.LITTLE_ENDIAN);</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">for</span> (n = bb.remaining(); n &gt; <span class="number">0</span> &amp;&amp; bb.get(n - <span class="number">1</span>) == <span class="number">0</span>; n--)</span><br><span class="line">        ;</span><br><span class="line">    <span class="keyword">long</span>[] words = <span class="keyword">new</span> <span class="keyword">long</span>[(n + <span class="number">7</span>) / <span class="number">8</span>];</span><br><span class="line">    bb.limit(n);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (bb.remaining() &gt;= <span class="number">8</span>)</span><br><span class="line">        words[i++] = bb.getLong();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> remaining = bb.remaining(), j = <span class="number">0</span>; j &lt; remaining; j++)</span><br><span class="line">        words[i] |= (bb.get() &amp; <span class="number">0xffL</span>) &lt;&lt; (<span class="number">8</span> * j);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BitSet(words);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitSet <span class="title">valueOf</span><span class="params">(<span class="keyword">long</span>[] longs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">for</span> (n = longs.length; n &gt; <span class="number">0</span> &amp;&amp; longs[n - <span class="number">1</span>] == <span class="number">0</span>; n--)</span><br><span class="line">        ;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BitSet(Arrays.copyOf(longs, n));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitSet <span class="title">valueOf</span><span class="params">(LongBuffer lb)</span> </span>&#123;</span><br><span class="line">    lb = lb.slice();</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">for</span> (n = lb.remaining(); n &gt; <span class="number">0</span> &amp;&amp; lb.get(n - <span class="number">1</span>) == <span class="number">0</span>; n--)</span><br><span class="line">        ;</span><br><span class="line">    <span class="keyword">long</span>[] words = <span class="keyword">new</span> <span class="keyword">long</span>[n];</span><br><span class="line">    lb.get(words);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BitSet(words);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/Wechat.jpeg"
                alt="祝欣鸿" />
            
              <p class="site-author-name" itemprop="name">祝欣鸿</p>
              <p class="site-description motion-element" itemprop="description">时光如白马，稍纵即逝。术业有专攻，一生做好一件事真的很重要。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">祝欣鸿</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
